#!/usr/bin/env php
<?php

require_once __DIR__ . '/../src/GitHubApiClientInterface.php';
require_once __DIR__ . '/../src/GitHubApiClient.php';
require_once __DIR__ . '/../src/LogParser.php';
require_once __DIR__ . '/../src/FailedTestFinder.php';
require_once __DIR__ . '/../src/PhpUnitRunner.php';
require_once __DIR__ . '/../src/GitHubOutput.php';

// ── Inputs (from environment variables set by action.yml) ──────────────────

$token          = (string) (getenv('GH_TOKEN') ?: '');
$repo           = (string) (getenv('GITHUB_REPOSITORY') ?: '');
$workflowName   = (string) (getenv('WORKFLOW_NAME') ?: '');
$branch         = (string) (getenv('BRANCH') ?: '');
$maxRuns        = (int)    (getenv('MAX_RUNS') ?: '5');
$phpunitCommand = (string) (getenv('PHPUNIT_COMMAND') ?: 'vendor/bin/phpunit');
$runTests       = $phpunitCommand !== 'false';
$phpunitArgs    = (string) (getenv('PHPUNIT_ARGS') ?: '');

// Default workflow name: extract filename from GITHUB_WORKFLOW_REF
// e.g. "owner/repo/.github/workflows/main.yml@refs/heads/main" → "main.yml"
if ($workflowName === '') {
    $workflowRef = (string) (getenv('GITHUB_WORKFLOW_REF') ?: '');
    if (preg_match('/\/([^\/]+\.ya?ml)@/', $workflowRef, $m)) {
        $workflowName = $m[1];
    }
}

// Default branch
if ($branch === '') {
    $branch = (string) (getenv('GITHUB_REF_NAME') ?: 'main');
}

// ── Bootstrap ─────────────────────────────────────────────────────────────

$output = new GitHubOutput();
$api    = new GitHubApiClient($token);
$finder = new FailedTestFinder($api, new LogParser());
$runner = new PhpUnitRunner();

// ── Find previously failed tests ───────────────────────────────────────────

$output->log("Searching for failed tests in workflow=$workflowName branch=$branch max_runs=$maxRuns");

$failedTests = $finder->find($repo, $workflowName, $branch, $maxRuns);

// ── Re-run previously failed tests (if any) ───────────────────────────────

if (empty($failedTests)) {
    $output->log('No previously failed tests found.');
    $output->set('failed-tests', '');
    $output->set('filter', '');
    $output->set('rerun-result', 'skip');
} else {
    $output->log('Found previously failed tests:');
    foreach ($failedTests as $test) {
        $output->log("  $test");
    }

    // Build PHPUnit --filter regex: strip namespace, keep Class::method
    $filterParts = array_map(
        static fn(string $test): string => preg_replace('/^.*\\\\/', '', $test),
        $failedTests
    );
    $filter = implode('|', $filterParts);

    $output->set('failed-tests', implode(',', $failedTests));
    $output->set('filter', $filter);

    if ($runTests) {
        $output->group('Re-running previously failed tests');
        $output->log("Filter: $filter");
        $rerunExitCode = $runner->run($phpunitCommand, $filter, $phpunitArgs);
        $output->endGroup();

        if ($rerunExitCode === 0) {
            $output->set('rerun-result', 'pass');
            $output->log('Previously failed tests now pass.');
        } else {
            $output->set('rerun-result', 'fail');
            $output->log('Some previously failed tests are still failing.');
        }
    } else {
        $output->set('rerun-result', 'skip');
    }
}

// ── Run the full test suite ────────────────────────────────────────────────

if (!$runTests) {
    exit(0);
}

$output->group('Full test suite');
$fullExitCode = $runner->run($phpunitCommand, '', $phpunitArgs);
$output->endGroup();

exit($fullExitCode);
